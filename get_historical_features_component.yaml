name: Get Historical Features
description: Retrieve historical features from Feast and save as a CSV file
inputs:
  - {name: Entity IDs, type: String}
  - {name: Feature Service Name, type: String}
  - {name: Output Path Prefix, type: String}
outputs:
  - {name: Historical Features, type: CSV}
metadata:
  annotations:
    author: Sam Yu <your_email@domain.com>
implementation:
  container:
    image: python:3.10
    command:
      - sh
      - -ex
      - -c
      - |
          (PIP_DISABLE_PIP_VERSION_CHECK=1 python3 -m pip install --quiet feast pandas || \
           PIP_DISABLE_PIP_VERSION_CHECK=1 python3 -m pip install --quiet feast pandas --user)
          python3 -u -c "
import os
import pandas as pd
from feast import FeatureStore

store = FeatureStore(repo_path='.')
entity_ids = '${0}'.split(',')  # Assume comma-separated student IDs
feature_service = store.get_feature_service(name='${1}')
df = store.get_historical_features(
    entity_df=pd.DataFrame({'student_id': entity_ids}),
    features=feature_service
).to_df()

output_path = '${2}/historical_features.csv'
os.makedirs(os.path.dirname(output_path), exist_ok=True)
df.to_csv(output_path, index=False)
print('âœ… Historical features saved to:', output_path)
          "
      - inputValue: Entity IDs
      - inputValue: Feature Service Name
      - inputValue: Output Path Prefix
      - outputPath: Historical Features
