name: Feast - Get Historical Features (Mocked)
description: Retrieve historical features from Feast using student entity data and feature view

inputs:
  - {name: entity_data_path, type: String, description: 'Path to entity data CSV (must include event_timestamp)'}
  - {name: feature_view_name, type: String, default: 'student_feature_view', description: 'Feast feature view to use'}
  - {name: repo_path, type: String, default: 'feature_repo', description: 'Path to mounted Feast repo'}

outputs:
  - {name: historical_features_path, type: String, description: 'Path to write retrieved historical features as CSV'}

implementation:
  container:
    image: python:3.10
    command: [python]
    args:
      - -c
      - |
        import os
        import pandas as pd
        import argparse
        from feast import FeatureStore

        parser = argparse.ArgumentParser()
        parser.add_argument('--entity_data_path', type=str, required=True)
        parser.add_argument('--feature_view_name', type=str, required=True)
        parser.add_argument('--repo_path', type=str, required=True)
        parser.add_argument('--historical_features_path', type=str, required=True)
        args = parser.parse_args()

        os.makedirs(os.path.dirname(args.historical_features_path), exist_ok=True)

        print(f"ðŸ“„ Reading entity data from {args.entity_data_path}")
        entity_df = pd.read_csv(args.entity_data_path, parse_dates=["event_timestamp"])

        print(f"ðŸ§  Loading Feast FeatureStore from: {args.repo_path}")
        store = FeatureStore(repo_path=args.repo_path)

        print(f"ðŸ”— Getting features from: {args.feature_view_name}")
        feature_refs = [f"{args.feature_view_name}:{f.name}" for f in store.get_feature_view(args.feature_view_name).features]
        df = store.get_historical_features(entity_df=entity_df, features=feature_refs).to_df()

        df.to_csv(args.historical_features_path, index=False)
        print(f"âœ… Historical features saved to {args.historical_features_path}")
      - --entity_data_path
      - {inputValue: entity_data_path}
      - --feature_view_name
      - {inputValue: feature_view_name}
      - --repo_path
      - {inputValue: repo_path}
      - --historical_features_path
      - {outputPath: historical_features_path}
